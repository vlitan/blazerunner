#include "motors.h"
#include "sensors.h"
#include "display.h"
#include <LiquidCrystal_I2C.h>
#include "imu.h"
#include "startModule.h"
#include "switches.h"

bool sensorStates[4];
int distances[4];
float yaw;
float pitch;
float roll;
strategy_t strategy;

void setup() {
 setupMotors();
 mpu_setup(220, 76, -85, 1788);
 setupDisplay();
 setupSensors();
 setupStartModule();
 setupSwitches();
 displayMessage("waiting for start");
 busyWaitForStart();
 strategy = getStrategy();
}



void loop() {
  if (!stopped()){
    switch(strategy){
      case testStrat: runTest(); break;
      case rightWallFollowerStrat: wallFollower(rightTurn); break;
      case leftWallFollowerStrat: wallFollower(leftTurn); break;
      case decisionArrayStrat: runDecisionArray(); break;
      default : runDefault();
    }
  }
  else{
    stop();
  }
}

void runDecisionArray(){
  displayMessage("decision array N/A");
  delay(100);
}

void wallFollower(turnDirection_t turn){
  if (turn == rightTurn){
    displayMessage("folllow right");
  }
  else if (turn == leftTurn){
    displayMessage("folllow left");
  }
  else{
    displayMessage("folllow N/A");
  }
  delay(100);
}

void runDefault(){
  displayMessage("defaul strat N/A");
  delay(100);
}

void runTest(){
  static int count = 0;
  if (count < 10){
    //check lcd
    displayMessage("Running test");
  }
  else if (count <= 100){
    //check gyro
    update_ypr(&yaw, &pitch, &roll);
    displayYPR(yaw, pitch, roll);
  }
  else if(count <= 200){
    //check sensors
    updateSensorDistances(distances);
    displayDistances(distances);
  }
  else if(count <= 300){
    //check motors
    drive(forwardDrive);
  }
  delay(100);
  count++;
  if (count >= 400){
    stop();
    count = 0;
  }
}

